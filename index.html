<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>To-Do List</title>
    
    <!-- APP LOGO SETUP -->
    <link rel="icon" type="image/jpeg" href="logo.jpg">
    <link rel="apple-touch-icon" href="logo.jpg">

    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #ffffff;
            --accent: #bb86fc;
            --success: #03dac6;
            --error: #cf6679;
            --warning: #ffb74d;
            --heavy-glow: rgba(88, 86, 214, 0);
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            transition: background-color 0.8s ease;
        }

        /* The heavy load glow container */
        .bottom-glow {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0;
            background: linear-gradient(to top, var(--heavy-glow), transparent);
            pointer-events: none;
            z-index: 5;
            transition: all 0.5s ease;
        }

        h1 { margin-bottom: 20px; font-weight: 300; letter-spacing: 2px; }

        /* --- Floating Action Button (FAB) --- */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: var(--accent);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            font-weight: bold;
            color: black;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.2s;
            border: none;
        }
        .fab:active { transform: scale(0.9); }

        /* --- Popup Input Section --- */
        .popup-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: flex-end; 
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .controls {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .popup-active .popup-overlay { display: flex; opacity: 1; }
        .popup-active .controls { transform: translateY(0); }

        .close-popup {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: auto;
        }

        input[type="text"], input[type="date"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background: #2c2c2c;
            border: 1px solid #444;
            color: white;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
        }
        
        input[type="date"] {
            -webkit-appearance: none;
            appearance: none;
            min-height: 45px; 
        }

        label { display: block; margin-bottom: 5px; font-size: 0.9em; color: #aaa; }
        
        /* --- TABS SECTION IN POPUP --- */
        .tabs-section {
            margin-bottom: 20px;
            padding: 10px;
            background: #252525;
            border-radius: 8px;
        }
        .saved-tabs-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        .tab-chip {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            color: white;
            cursor: pointer;
            border: 2px solid transparent;
            opacity: 0.7;
            transition: opacity 0.2s, transform 0.2s;
        }
        .tab-chip.selected {
            border-color: white;
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 0 8px rgba(255,255,255,0.3);
        }
        .new-tab-inputs {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .color-picker {
            width: 40px;
            height: 40px;
            border: none;
            background: none;
            cursor: pointer;
        }
        
        /* --- SLIDER IMPROVEMENTS --- */
        .slider-container { margin-bottom: 20px; }
        
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 15px;
            background: #444;
            border-radius: 10px;
            outline: none;
            cursor: pointer;
            margin: 10px 0;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 30px;
            background: var(--text-color);
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        button.add-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--accent);
            color: black;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }

        button.small-btn {
            padding: 8px;
            font-size: 0.8em;
            width: auto;
            margin-top: 0;
        }

        /* --- PINNED SECTION --- */
        #pinned-section {
            width: 100%;
            max-width: 500px;
            margin-bottom: 20px;
            display: none; 
        }
        .pinned-card {
            background: linear-gradient(135deg, #2a2a2a, #222);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(187, 134, 252, 0.2);
            position: relative;
        }
        .time-bar-bg {
            width: 100%;
            height: 6px;
            background: #444;
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
            position: relative;
        }
        .time-bar-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.5s;
        }
        .completion-bar-bg {
            width: 100%;
            height: 6px;
            background: #444;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        .completion-bar-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.5s;
        }
        .pinned-stat-label {
            font-size: 0.7em;
            color: #888;
            margin-top: 5px;
        }

        /* --- List Section --- */
        #todo-list {
            width: 100%;
            max-width: 500px;
            list-style: none;
            padding: 0;
            padding-bottom: 100px; 
            position: relative;
            z-index: 10;
        }

        .todo-item {
            background: var(--card-bg);
            margin-bottom: 15px;
            /* Added margin-top to allow tab to sit outside */
            margin-top: 30px; 
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            position: relative;
            /* Allow tab to stick out */
            overflow: visible; 
            border-left: 5px solid var(--accent);
        }
        
        .todo-item.overdue {
            border-left-color: var(--error);
        }
        .todo-item.overdue .todo-date {
            color: var(--error);
            background: rgba(207, 102, 121, 0.15);
        }
        .overdue-icon {
            color: var(--error);
            font-size: 1.2em;
            margin-right: 5px;
            display: none;
        }
        .todo-item.overdue .overdue-icon {
            display: inline;
        }

        /* UPDATED: File Folder Tab Style */
        .tab-badge {
            position: absolute;
            top: -24px; /* Sits on top */
            left: 0;
            padding: 4px 15px;
            border-radius: 8px 8px 0 0; /* Curved top */
            font-size: 0.75em;
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            z-index: 1; /* Ensure visible */
            box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
        }

        .todo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .todo-title { 
            font-weight: bold; 
            word-break: break-word; 
            flex-grow: 1;
            padding-right: 10px;
            display: flex;
            align-items: center;
        }
        
        .todo-date { 
            color: white; 
            white-space: nowrap; 
            margin-left: 10px; 
            background: rgba(255,255,255,0.1);
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: bold;
            position: relative; 
            display: inline-block; 
        }
        
        /* UPDATED: Pin Icon SVG styling */
        .pin-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 0 0 10px;
            display: flex;
            align-items: center;
        }
        .pin-icon {
            width: 20px;
            height: 20px;
            fill: #555;
            transition: fill 0.3s;
        }
        .pin-btn.active .pin-icon {
            fill: var(--accent);
        }

        /* --- DATE INPUT FIX --- */
        .date-input-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            opacity: 0; z-index: 10; cursor: pointer; border: none; padding: 0; margin: 0;
        }
        .date-input-overlay::-webkit-calendar-picker-indicator {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 0; cursor: pointer;
        }

        /* Dynamic Sizing Classes */
        .size-1 { transform: scale(0.95); opacity: 0.9; }
        .size-2 { transform: scale(1); }
        .size-3 { transform: scale(1.02); font-size: 1.05em; border-left-width: 8px; }
        .size-4 { transform: scale(1.05); font-size: 1.1em; border-left-width: 10px; }
        .size-5 { transform: scale(1.08); font-size: 1.2em; border-left-width: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.6); font-weight: bold; }

        /* Progress Slider */
        .progress-wrapper { margin-top: 15px; }
        .progress-label {
            font-size: 0.7em; text-align: right; margin-bottom: 2px; color: #888;
        }
        
        /* Animations */
        @keyframes successPop {
            0% { transform: scale(1); background-color: var(--success); }
            50% { transform: scale(1.1); box-shadow: 0 0 30px var(--success); }
            100% { transform: scale(0); opacity: 0; margin: 0; padding: 0; height: 0; }
        }
        .completed-anim {
            animation: successPop 0.8s forwards ease-in-out;
            pointer-events: none; background-color: var(--success) !important; color: black; border: none;
        }

        /* Confetti */
        .confetti {
            position: fixed; width: 10px; height: 10px; background-color: #f00; 
            animation: fall linear forwards; z-index: 2000; pointer-events: none;
        }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        
        .firework-particle {
            position: fixed; width: 6px; height: 6px; border-radius: 50%; z-index: 2001; 
            pointer-events: none; animation: fireworkFly 1s ease-out forwards; box-shadow: 0 0 8px currentColor;
        }
        @keyframes fireworkFly {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--dx), var(--dy)) scale(0.5); opacity: 0; }
        }

        /* Empty State */
        .empty-state {
            text-align: center; color: #555; margin-top: 40px; 
            display: flex; flex-direction: column; align-items: center; width: 100%;
        }
        .empty-state img {
            max-width: 90%; border-radius: 15px; margin-bottom: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); width: 350px;
        }
        .empty-state p {
            font-size: 1.2em; color: var(--accent); font-weight: 300;
        }

    </style>
</head>
<body>

    <h1>To-Do List</h1>

    <!-- Glow Effect for heavy load -->
    <div id="bottomGlow" class="bottom-glow"></div>

    <!-- PINNED TASK SECTION -->
    <div id="pinned-section">
        <div class="pinned-card">
            <!-- Labels removed as requested -->
            <div id="pinned-content">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="togglePopup()">+</button>

    <!-- Popup Input Form -->
    <div class="popup-overlay" id="popupOverlay" onclick="if(event.target === this) togglePopup()">
        <div class="controls">
            <button class="close-popup" onclick="togglePopup()">×</button>
            <h2 style="margin-top:0; font-weight:300;">New Task</h2>
            
            <label>Task Description</label>
            <input type="text" id="taskInput" placeholder="What needs doing?">

            <label>Due Date</label>
            <input type="date" id="dateInput">

            <!-- TABS SECTION -->
            <label>Add a Tab (Optional)</label>
            <div class="tabs-section">
                <div class="saved-tabs-list" id="savedTabsList">
                    <!-- Saved tabs appear here -->
                </div>
                <div class="new-tab-inputs">
                    <input type="text" id="newTabName" placeholder="New tab name" style="margin-bottom:0; font-size: 0.9em;">
                    <input type="color" id="newTabColor" class="color-picker" value="#bb86fc">
                    <button class="add-btn small-btn" onclick="saveNewTab()">Save</button>
                </div>
                <input type="hidden" id="selectedTabName">
                <input type="hidden" id="selectedTabColor">
            </div>

            <div class="slider-container">
                <label>Assignment Size (1-5): <span id="sizeVal" style="color:var(--accent); font-weight:bold;">1</span></label>
                <input type="range" id="sizeInput" min="1" max="5" value="1" oninput="document.getElementById('sizeVal').innerText = this.value">
            </div>

            <button class="add-btn" onclick="addTask()">ADD TASK</button>
        </div>
    </div>

    <ul id="todo-list">
        <!-- Tasks will appear here -->
    </ul>

    <script>
        // 1. Initialize State
        let tasks = JSON.parse(localStorage.getItem('myTasks')) || [];
        let savedTabs = JSON.parse(localStorage.getItem('myTabs')) || [];
        let pinnedTaskId = localStorage.getItem('pinnedTaskId') || null;

        tasks.forEach(t => {
            if(!t.id) t.id = Date.now() + Math.random();
            if(!t.createdAt) t.createdAt = Date.now();
        });

        const listEl = document.getElementById('todo-list');
        const glowEl = document.getElementById('bottomGlow');
        const pinnedSection = document.getElementById('pinned-section');
        const pinnedContent = document.getElementById('pinned-content');
        const todayDate = new Date();
        todayDate.setHours(0,0,0,0);

        // 2. Toggle Popup
        function togglePopup() {
            document.body.classList.toggle('popup-active');
            if(document.body.classList.contains('popup-active')) {
                document.getElementById('taskInput').focus();
                
                const today = new Date().toISOString().split('T')[0];
                const dateInput = document.getElementById('dateInput');
                if(!dateInput.value) dateInput.value = today;

                renderSavedTabs();
                clearSelectedTab();
            }
        }

        // --- TABS LOGIC ---
        function renderSavedTabs() {
            const container = document.getElementById('savedTabsList');
            container.innerHTML = '';
            savedTabs.forEach((tab, index) => {
                const chip = document.createElement('div');
                chip.className = 'tab-chip';
                chip.style.backgroundColor = tab.color;
                chip.innerText = tab.name;
                chip.onclick = () => selectTab(tab.name, tab.color, chip);
                container.appendChild(chip);
            });
        }

        function saveNewTab() {
            const name = document.getElementById('newTabName').value.trim();
            const color = document.getElementById('newTabColor').value;
            if(name) {
                savedTabs.push({ name, color });
                localStorage.setItem('myTabs', JSON.stringify(savedTabs));
                document.getElementById('newTabName').value = '';
                renderSavedTabs();
                const chips = document.getElementById('savedTabsList').children;
                if(chips.length > 0) chips[chips.length-1].click();
            }
        }

        function selectTab(name, color, chipElement) {
            const allChips = document.querySelectorAll('.tab-chip');
            allChips.forEach(c => c.classList.remove('selected'));
            chipElement.classList.add('selected');

            document.getElementById('selectedTabName').value = name;
            document.getElementById('selectedTabColor').value = color;
        }

        function clearSelectedTab() {
            document.getElementById('selectedTabName').value = '';
            document.getElementById('selectedTabColor').value = '';
            const allChips = document.querySelectorAll('.tab-chip');
            allChips.forEach(c => c.classList.remove('selected'));
        }

        // 3. Render List
        function renderTasks() {
            listEl.innerHTML = '';
            
            tasks.sort((a, b) => {
                if (!a.date) return 1;
                if (!b.date) return -1;
                return new Date(a.date) - new Date(b.date);
            });

            let loadScore = 0;
            let pinnedTask = null;

            if (tasks.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <img src="https://cdn.decrypt.co/wp-content/uploads/2024/11/chillguy-gID_7.jpg" alt="Chill guy">
                        <p>Nothing here, you're all good to chill.</p>
                    </div>`;
                pinnedSection.style.display = 'none';
                updateVisuals(0);
                return;
            }

            tasks.forEach((task, index) => {
                if (parseInt(task.size) >= 4) loadScore += parseInt(task.size);
                if (task.id == pinnedTaskId) pinnedTask = task;

                const li = document.createElement('li');
                
                let isOverdue = false;
                if(task.date) {
                    const d = new Date(task.date + 'T00:00:00');
                    if(d < todayDate) isOverdue = true;
                }

                li.className = `todo-item size-${task.size} ${isOverdue ? 'overdue' : ''}`;
                li.id = `task-${task.id}`;
                
                const progressColor = `linear-gradient(90deg, var(--accent) ${task.progress}%, #333 ${task.progress}%)`;
                
                let dateDisplay = '';
                let fontSize = '0.9em'; 

                if (task.date) {
                    const taskDate = new Date(task.date + 'T00:00:00'); 
                    dateDisplay = taskDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const diffTime = taskDate - todayDate;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays <= 1) fontSize = '1.4em';
                    else if (diffDays <= 3) fontSize = '1.2em';
                    else if (diffDays <= 7) fontSize = '1.0em';
                }

                // Tab Badge (Curved folder style)
                let tabHtml = '';
                if(task.tabName) {
                    tabHtml = `<div class="tab-badge" style="background-color: ${task.tabColor}">${task.tabName}</div>`;
                }

                const pinClass = (task.id == pinnedTaskId) ? 'active' : '';

                li.innerHTML = `
                    ${tabHtml}
                    <div class="todo-header">
                        <span class="todo-title">
                            <span class="overdue-icon">⚠️</span>
                            ${task.text}
                        </span>
                        ${dateDisplay ? `
                            <span class="todo-date" style="font-size: ${fontSize}">
                                ${dateDisplay}
                                <input type="date" 
                                       class="date-input-overlay"
                                       onchange="updateDate(${index}, this.value)"
                                       value="${task.date}">
                            </span>
                        ` : ''}
                        <button class="pin-btn ${pinClass}" onclick="togglePin('${task.id}')">
                            <svg class="pin-icon" viewBox="0 0 24 24">
                                <path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z" />
                            </svg>
                        </button>
                    </div>
                    <div class="progress-wrapper">
                        <div class="progress-label">${task.progress}% Done</div>
                        <input type="range" 
                               class="progress-slider" 
                               min="0" max="100" 
                               value="${task.progress}" 
                               style="background: ${progressColor}"
                               oninput="updateProgress(${index}, this.value, this)"
                               ontouchstart="event.stopPropagation()">
                    </div>
                `;
                listEl.appendChild(li);
            });

            updateVisuals(loadScore);
            renderPinnedTask(pinnedTask);
        }

        // --- PINNED LOGIC ---
        function togglePin(id) {
            if(pinnedTaskId == id) {
                pinnedTaskId = null;
            } else {
                pinnedTaskId = id;
            }
            localStorage.setItem('pinnedTaskId', pinnedTaskId);
            renderTasks();
        }

        function renderPinnedTask(task) {
            if(!task) {
                pinnedSection.style.display = 'none';
                return;
            }

            pinnedSection.style.display = 'block';
            
            // Urgency %
            let timePercent = 0;
            let dateDisplay = 'No Date';
            let fontSize = '1.2em';

            if(task.date) {
                const start = task.createdAt || (Date.now() - 86400000); 
                const due = new Date(task.date + 'T23:59:59').getTime();
                const now = Date.now();
                const totalDuration = due - start;
                const elapsed = now - start;
                
                if(totalDuration > 0) {
                    timePercent = Math.min(100, Math.max(0, (elapsed / totalDuration) * 100));
                } else {
                    timePercent = 100; 
                }

                // Format Date neatly for pinned card
                const taskDate = new Date(task.date + 'T00:00:00'); 
                dateDisplay = taskDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const diffTime = taskDate - todayDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays <= 1) fontSize = '1.5em';
                else if (diffDays <= 3) fontSize = '1.3em';
            }

            pinnedContent.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="margin: 0; font-weight: 300;">${task.text}</h2>
                    <div style="text-align:right;">
                        <span style="font-size:${fontSize}; font-weight:bold; color:white;">${dateDisplay}</span>
                    </div>
                </div>
                
                <div class="pinned-stat-label">Time Progress</div>
                <div class="time-bar-bg">
                    <div class="time-bar-fill" style="width: ${timePercent}%"></div>
                </div>

                <div class="pinned-stat-label">Progress (${task.progress}%)</div>
                <div class="completion-bar-bg">
                    <div class="completion-bar-fill" style="width: ${task.progress}%"></div>
                </div>
            `;
        }

        function updateDate(index, newDate) {
            if (newDate) {
                tasks[index].date = newDate;
                saveAndRender();
            }
        }

        function updateVisuals(score) {
            if (score < 4) {
                glowEl.style.height = '0';
                glowEl.style.setProperty('--heavy-glow', 'rgba(88, 86, 214, 0)');
                document.body.style.backgroundColor = 'var(--bg-color)'; 
            } else {
                const intensity = Math.min(score / 25, 0.9); 
                const height = Math.min(score * 20, 350); 
                glowEl.style.height = height + 'px';
                glowEl.style.setProperty('--heavy-glow', `rgba(88, 86, 255, ${intensity})`);
                if (score > 8) document.body.style.backgroundColor = '#050505'; 
                else document.body.style.backgroundColor = '#0e0e0e';
            }
        }

        function addTask() {
            const textInput = document.getElementById('taskInput');
            const dateInput = document.getElementById('dateInput');
            const sizeInput = document.getElementById('sizeInput');
            
            const tabName = document.getElementById('selectedTabName').value;
            const tabColor = document.getElementById('selectedTabColor').value;

            if (textInput.value.trim() === "") {
                textInput.style.borderColor = "var(--error)";
                setTimeout(() => textInput.style.borderColor = "#444", 1500);
                return;
            }

            const newTask = {
                id: Date.now(),
                createdAt: Date.now(),
                text: textInput.value,
                date: dateInput.value,
                size: sizeInput.value,
                progress: 0,
                tabName: tabName || null,
                tabColor: tabColor || null
            };

            tasks.push(newTask);
            saveAndRender();
            
            textInput.value = '';
            dateInput.value = new Date().toISOString().split('T')[0];
            sizeInput.value = '1';
            document.getElementById('sizeVal').innerText = '1';
            togglePopup();
        }

        function updateProgress(index, value, element) {
            tasks[index].progress = value;
            element.style.background = `linear-gradient(90deg, var(--accent) ${value}%, #333 ${value}%)`;
            element.previousElementSibling.innerText = `${value}% Done`;

            if (value == 100) {
                const task = tasks[index];
                const taskItem = document.getElementById(`task-${task.id}`);
                if(taskItem) taskItem.classList.add('completed-anim');
                
                if(task.id == pinnedTaskId) {
                    pinnedTaskId = null;
                    localStorage.removeItem('pinnedTaskId');
                }

                const isBigTask = parseInt(task.size) >= 4;
                spawnConfetti(isBigTask);
                if (isBigTask) spawnFireworks();

                setTimeout(() => {
                    deleteTask(index);
                }, 800);
            } else {
                localStorage.setItem('myTasks', JSON.stringify(tasks));
                // If this is the pinned task, re-render pin section to update progress bar
                const task = tasks[index];
                if (task.id == pinnedTaskId) {
                    renderPinnedTask(task);
                }
            }
        }

        function spawnConfetti(isBig) {
            const count = isBig ? 300 : 50; 
            const colors = isBig 
                ? ['#FFD700', '#E5E4E2', '#ffffff', '#bb86fc', '#5050ff'] 
                : ['#ff0', '#f00', '#0f0', '#00f', '#0ff', '#f0f']; 

            for(let i=0; i<count; i++) {
                const conf = document.createElement('div');
                conf.classList.add('confetti');
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.top = '-10px';
                conf.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
                
                const speed = isBig ? (Math.random() * 4 + 2) : (Math.random() * 2 + 1);
                conf.style.animationDuration = speed + 's';
                
                if(isBig) {
                    const size = Math.random() * 8 + 5;
                    conf.style.width = size + 'px';
                    conf.style.height = size + 'px';
                }

                document.body.appendChild(conf);
                setTimeout(() => conf.remove(), speed * 1000);
            }
        }

        function spawnFireworks() {
            const colors = ['#FFD700', '#00ff00', '#ff00ff', '#00ffff', '#ffffff', '#ff4500'];
            for(let i=0; i<80; i++) createFireworkParticle(0, window.innerHeight, colors);
            for(let i=0; i<80; i++) createFireworkParticle(window.innerWidth, window.innerHeight, colors);
        }

        function createFireworkParticle(x, y, colors) {
            const p = document.createElement('div');
            p.classList.add('firework-particle');
            p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            p.style.left = x + 'px';
            p.style.top = y + 'px';

            const xDir = x === 0 ? 1 : -1;
            const destX = (Math.random() * 400 + 50) * xDir + 'px';
            const destY = -(Math.random() * 600 + 200) + 'px'; 

            p.style.setProperty('--dx', destX);
            p.style.setProperty('--dy', destY);

            document.body.appendChild(p);
            setTimeout(() => p.remove(), 1000);
        }

        function deleteTask(index) {
            tasks.splice(index, 1);
            saveAndRender();
        }

        function saveAndRender() {
            localStorage.setItem('myTasks', JSON.stringify(tasks));
            renderTasks();
        }

        renderTasks();

    </script>
</body>
</html>
